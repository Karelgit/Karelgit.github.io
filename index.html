<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Make western countries&#39; engineers ashamed">
<meta property="og:type" content="website">
<meta property="og:title" content="">
<meta property="og:url" content="https://russan.club/">
<meta property="og:site_name" content="">
<meta property="og:description" content="Make western countries&#39; engineers ashamed">
<meta property="article:author" content="Karel">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '0RXDAGJL37',
      apiKey: '18b8938443d14d0fc6067350be22a19d',
      indexName: 'dev_karel',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://russan.club/"/>





  <title></title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title"></span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://russan.club/2020/03/28/dreamviewer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Karel">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/28/dreamviewer/" itemprop="url">做了个梦</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-28T09:19:59+08:00">
                2020-03-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%BA%E6%96%87/" itemprop="url" rel="index">
                    <span itemprop="name">人文</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/28/dreamviewer/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/03/28/dreamviewer/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2020/03/28/dreamviewer/" class="leancloud_visitors" data-flag-title="做了个梦">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>2020-03-28 做了个梦，感觉有点意思，把它记录下来</p>
</blockquote>
<p>​       在我30多岁这一年的这一天，我一个以前的同事，把中小学课程通过盗版渠道成立了一个在线教育和直播平台，居然做成了全国的规范。中午他又和同事因为处事方式的激进和不可调和，在办公园区大打出手，脸上挂红，其实我和他已经好几年没有联系了，很大原因也是因为他的脾气确实也是烂得没话说。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2020/03/28/dreamviewer/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://russan.club/2020/03/27/%E3%80%8A%E5%A8%B1%E4%B9%90%E8%87%B3%E6%AD%BB%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Karel">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/27/%E3%80%8A%E5%A8%B1%E4%B9%90%E8%87%B3%E6%AD%BB%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" itemprop="url">《娱乐至死》读书笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-27T17:12:31+08:00">
                2020-03-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%BB%E4%B9%A6/" itemprop="url" rel="index">
                    <span itemprop="name">读书</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/27/%E3%80%8A%E5%A8%B1%E4%B9%90%E8%87%B3%E6%AD%BB%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/03/27/%E3%80%8A%E5%A8%B1%E4%B9%90%E8%87%B3%E6%AD%BB%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2020/03/27/%E3%80%8A%E5%A8%B1%E4%B9%90%E8%87%B3%E6%AD%BB%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" class="leancloud_visitors" data-flag-title="《娱乐至死》读书笔记">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://russan.club/2020/03/26/spring-cloud-gateway/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Karel">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/26/spring-cloud-gateway/" itemprop="url">灵活网关SpringCloud Gateway</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-03-26T16:12:26+08:00">
                2020-03-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SpringCloud/" itemprop="url" rel="index">
                    <span itemprop="name">SpringCloud</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/03/26/spring-cloud-gateway/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/03/26/spring-cloud-gateway/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2020/03/26/spring-cloud-gateway/" class="leancloud_visitors" data-flag-title="灵活网关SpringCloud Gateway">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="异常处理的一头一尾"><a class="header-anchor" href="#异常处理的一头一尾">¶</a>异常处理的一头一尾</h3>
<p>​		在使用网关进行微服务管理的工程中，我们编写了包含鉴权、限流的解决方案，加在访问到业务代码API之前，下面进入流程：</p>
<p><img src="/2020/03/26/spring-cloud-gateway/main-frame.png" alt="项目访问控制"></p>
<center>网关控制流程图</center>
<p>​      SpringCloud 的异常处理不同于SpringMVC或者SpringBoot下的全局异常处理,因为底层的处理器不同,具体代码层表现为继承的类不同，SpringCloud需要继承DefaultErrorWebExceptionHandler进行异常处理,，SpringMVC和SpringBoot通过@ControllerAdvice<code>和</code>@ExceptionHandler处理不同的自定义异常处理逻辑。</p>
<img src="/2020/03/26/spring-cloud-gateway/project-layout.png" class="project-layout" width="300" height="40">
<center>项目结构图</center>
<h4 id="全局异常处理："><a class="header-anchor" href="#全局异常处理：">¶</a>全局异常处理：</h4>
<p>Order：@Order(Ordered.HIGHEST_PRECEDENCE)</p>
<p>进入全局异常处理类ErrorHandlerConfiguration</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>({ServerProperties<span class="class">.<span class="keyword">class</span>, <span class="title">ResourceProperties</span>.<span class="title">class</span>})</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ErrorHandlerConfiguration</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerProperties serverProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResourceProperties resourceProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ViewResolver&gt; viewResolvers;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerCodecConfigurer serverCodecConfigurer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ErrorHandlerConfiguration</span><span class="params">(ServerProperties serverProperties,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     ResourceProperties resourceProperties,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     ObjectProvider&lt;List&lt;ViewResolver&gt;&gt; viewResolversProvider,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     ServerCodecConfigurer serverCodecConfigurer,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     ApplicationContext applicationContext)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.serverProperties = serverProperties;</span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">        <span class="keyword">this</span>.resourceProperties = resourceProperties;</span><br><span class="line">        <span class="keyword">this</span>.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);</span><br><span class="line">        <span class="keyword">this</span>.serverCodecConfigurer = serverCodecConfigurer;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Order</span>(Ordered.HIGHEST_PRECEDENCE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ErrorWebExceptionHandler <span class="title">errorWebExceptionHandler</span><span class="params">(ErrorAttributes errorAttributes)</span> </span>{</span><br><span class="line">        ExceptionHandler exceptionHandler = <span class="keyword">new</span> ExceptionHandler(</span><br><span class="line">                errorAttributes,</span><br><span class="line">                <span class="keyword">this</span>.resourceProperties,</span><br><span class="line">                <span class="keyword">this</span>.serverProperties.getError(),</span><br><span class="line">                <span class="keyword">this</span>.applicationContext);</span><br><span class="line">        exceptionHandler.setViewResolvers(<span class="keyword">this</span>.viewResolvers);</span><br><span class="line">        exceptionHandler.setMessageWriters(<span class="keyword">this</span>.serverCodecConfigurer.getWriters());</span><br><span class="line">        exceptionHandler.setMessageReaders(<span class="keyword">this</span>.serverCodecConfigurer.getReaders());</span><br><span class="line">        <span class="keyword">return</span> exceptionHandler;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>该类在容器初始化的时候首先加载，后面的加载顺序会在Order上有体现，在errorWebExceptionHandler里面实现自定义的ExceptionHandler,在经过了所有的过滤器之后，如果不在白名单（表示此类访问直接通过，不需要进行鉴权，会在下面讲到用户鉴权），异常返回自定义如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionHandler</span> <span class="keyword">extends</span> <span class="title">DefaultErrorWebExceptionHandler</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ResultFilter resultFilter;</span><br><span class="line"></span><br><span class="line">    ExceptionHandler(ErrorAttributes errorAttributes, ResourceProperties resourceProperties, ErrorProperties errorProperties, ApplicationContext applicationContext) {</span><br><span class="line">        <span class="keyword">super</span>(errorAttributes, resourceProperties, errorProperties, applicationContext);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取异常请求以及属性，构造相应的返回结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Map&lt;String, Object&gt; <span class="title">getErrorAttributes</span><span class="params">(ServerRequest request, <span class="keyword">boolean</span> includeStackTrace)</span> </span>{</span><br><span class="line">        String notFound = <span class="string">"404 NOT_FOUND"</span>;</span><br><span class="line"></span><br><span class="line">        Result result;</span><br><span class="line">        Throwable error = <span class="keyword">super</span>.getError(request);</span><br><span class="line">        <span class="keyword">if</span> (error <span class="keyword">instanceof</span> org.springframework.cloud.gateway.support.NotFoundException) {</span><br><span class="line">            <span class="comment">//请求经过了所有filter，如果不再在白名单需要减去用户调用次数</span></span><br><span class="line">            result = <span class="keyword">new</span> Result(FailureResult.valueOf(<span class="string">"NULL_API"</span>));</span><br><span class="line">            returnCount(request);</span><br><span class="line"></span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (notFound.equals(error.getMessage())) {</span><br><span class="line">            result = <span class="keyword">new</span> Result(FailureResult.valueOf(<span class="string">"NULL_API"</span>));</span><br><span class="line"></span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (error <span class="keyword">instanceof</span> java.net.UnknownHostException){</span><br><span class="line">            <span class="comment">//请求经过了所有filter，如果不在白名单需要减去用户调用次数</span></span><br><span class="line">            result = <span class="keyword">new</span> Result(FailureResult.valueOf(<span class="string">"UNKNOW_HOST"</span>));</span><br><span class="line">            returnCount(request);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            result = <span class="keyword">new</span> Result(FailureResult.valueOf(<span class="string">"INTERNAL_ERROR"</span>));</span><br><span class="line">            result.setData(result.getData() + <span class="string">"："</span> + error.toString() + <span class="string">":"</span> + error.getMessage());</span><br><span class="line">            error.printStackTrace();</span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> result.toMap();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">returnCount</span><span class="params">(ServerRequest request)</span></span>{</span><br><span class="line">        Boolean inWhiteList = request.exchange().getAttribute(<span class="string">"inWhiteList"</span>);</span><br><span class="line">        inWhiteList = inWhiteList == <span class="keyword">null</span> ? Boolean.FALSE : inWhiteList;</span><br><span class="line">        resultFilter.returnApiCount(request.exchange(), inWhiteList);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定响应处理方法为JSON处理的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> RouterFunction&lt;ServerResponse&gt; <span class="title">getRoutingFunction</span><span class="params">(ErrorAttributes errorAttributes)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> RouterFunctions.route(RequestPredicates.all(), <span class="keyword">this</span>::renderErrorResponse);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将返回的响应状态都设置为200</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> HttpStatus <span class="title">getHttpStatus</span><span class="params">(Map&lt;String, Object&gt; errorAttributes)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> HttpStatus.valueOf(HttpStatus.OK.value());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="返回值包装"><a class="header-anchor" href="#返回值包装">¶</a>返回值包装</h4>
<p>在正常返回之前结果之前，需要对用户访问总数等进行更新，调用ResultFilter对返回结果进行封装:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResultFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> ModifyResponseBodyGatewayFilterFactory modifyResponseBodyGatewayFilterFactory;</span><br><span class="line">    <span class="keyword">private</span> GatewayFilter filter;</span><br><span class="line">    <span class="keyword">private</span> SyncCountTask syncCountTask;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResultFilter</span><span class="params">(ModifyResponseBodyGatewayFilterFactory modifyResponseBodyGatewayFilterFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">                        RedisTemplate&lt;String, String&gt; redisTemplate,</span></span></span><br><span class="line"><span class="function"><span class="params">                        SyncCountTask syncCountTask)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.modifyResponseBodyGatewayFilterFactory = modifyResponseBodyGatewayFilterFactory;</span><br><span class="line">        <span class="keyword">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">        <span class="keyword">this</span>.syncCountTask = syncCountTask;</span><br><span class="line">        filter = init();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>{</span><br><span class="line">        <span class="comment">//需要排除流（由于基于webFlux，modifyResponseBodyGatewayFilter结果需要阻塞流，因此需要单独处理）</span></span><br><span class="line">        String streamSign = <span class="string">"/stream/"</span>;</span><br><span class="line">        <span class="keyword">if</span> (exchange.getRequest().getPath().toString().contains(streamSign)) {</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> filter.filter(exchange, chain);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> NettyWriteResponseFilter.WRITE_RESPONSE_FILTER_ORDER - <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> GatewayFilter <span class="title">init</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> modifyResponseBodyGatewayFilterFactory.apply(c -&gt; c.setRewriteFunction(String<span class="class">.<span class="keyword">class</span>, <span class="title">String</span>.<span class="title">class</span>, (<span class="title">serverWebExchange</span>, <span class="title">s</span>) -&gt; </span>{</span><br><span class="line">            serverWebExchange.getResponse().getHeaders().setContentType(MediaType.APPLICATION_JSON_UTF8);</span><br><span class="line"></span><br><span class="line">            Boolean inWhiteList = serverWebExchange.getAttribute(<span class="string">"inWhiteList"</span>);</span><br><span class="line">            inWhiteList = inWhiteList == <span class="keyword">null</span> ? Boolean.FALSE : inWhiteList;</span><br><span class="line"></span><br><span class="line">            HttpStatus statusCode = serverWebExchange.getResponse().getStatusCode();</span><br><span class="line">            Result result;</span><br><span class="line">            <span class="keyword">if</span> (statusCode == HttpStatus.OK) {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    Result serverResult = JSONObject.parseObject(s, Result<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                    <span class="keyword">if</span> (serverResult.getCode() == <span class="keyword">null</span> &amp;&amp; serverResult.getMessage() == <span class="keyword">null</span>) {</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">                    }</span><br><span class="line">                    result = <span class="keyword">new</span> Result(serverResult.getData());</span><br><span class="line">                } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                    returnApiCount(serverWebExchange, inWhiteList);</span><br><span class="line">                    result = <span class="keyword">new</span> Result(FailureResult.valueOf(<span class="string">"ERROR_RESULT"</span>));</span><br><span class="line">                    <span class="keyword">return</span> Mono.just(result.toString());</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">//接口处理成功,提交后续操作</span></span><br><span class="line">                UserLimitEntity userLimitEntity = serverWebExchange.getAttribute(<span class="string">"userLimitEntity"</span>);</span><br><span class="line">                <span class="keyword">if</span> (!inWhiteList &amp;&amp; !userLimitEntity.notCountLimit()) {</span><br><span class="line">                    syncCountTask.sync(StringUtil.toMD5(serverWebExchange.getAttribute(<span class="string">"userId"</span>),</span><br><span class="line">                            serverWebExchange.getAttribute(<span class="string">"md5Path"</span>)));</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (statusCode == HttpStatus.NOT_FOUND) {</span><br><span class="line">                returnApiCount(serverWebExchange, inWhiteList);</span><br><span class="line">                changeStatusCode(serverWebExchange, HttpStatus.OK);</span><br><span class="line">                result = <span class="keyword">new</span> Result(FailureResult.valueOf(<span class="string">"UNSIGN_API"</span>));</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                Boolean isServerError = statusCode == <span class="keyword">null</span> || statusCode.is5xxServerError();</span><br><span class="line">                returnApiCount(serverWebExchange, inWhiteList);</span><br><span class="line">                changeStatusCode(serverWebExchange, HttpStatus.OK);</span><br><span class="line">                <span class="keyword">if</span> (isServerError) {</span><br><span class="line">                    result = <span class="keyword">new</span> Result(FailureResult.valueOf(<span class="string">"ERROR_SERVER"</span>));</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    result = <span class="keyword">new</span> Result(FailureResult.valueOf(<span class="string">"BAD_REQUEST"</span>));</span><br><span class="line">                }</span><br><span class="line">                String message = <span class="string">"服务异常"</span>;</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    JSONObject jsonObject = JSONObject.parseObject(s);</span><br><span class="line">                    message = jsonObject.getString(<span class="string">"message"</span>);</span><br><span class="line">                    String data = jsonObject.getString(<span class="string">"data"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (!StringUtils.isEmpty(data)) {</span><br><span class="line">                        message += <span class="string">"【"</span> + data + <span class="string">"】"</span>;</span><br><span class="line">                    }</span><br><span class="line">                } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                    System.err.println(<span class="string">"接口"</span> + serverWebExchange.getRequest().getPath() + <span class="string">"异常结果不统一。异常为："</span> + s);</span><br><span class="line">                }</span><br><span class="line">                result.setData(result.getData() + <span class="string">"："</span> + message);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> Mono.just(result.toString());</span><br><span class="line">        }));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Number <span class="title">str2num</span><span class="params">(String str)</span> <span class="keyword">throws</span> NumberFormatException </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> BigInteger(str);</span><br><span class="line">        } <span class="keyword">catch</span> (NumberFormatException e) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> BigDecimal(str);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnApiCount</span><span class="params">(ServerWebExchange exchange, <span class="keyword">boolean</span> inWhiteList)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (inWhiteList) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        UserLimitEntity userLimitEntity = exchange.getAttribute(<span class="string">"userLimitEntity"</span>);</span><br><span class="line">        <span class="keyword">if</span> (userLimitEntity.notCountLimit()) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        returnRedisCount(exchange);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">returnRedisCount</span><span class="params">(ServerWebExchange exchange)</span> </span>{</span><br><span class="line">        String redisPath = RedisPath.USER_COUNT_LIMIT + exchange.getAttribute(<span class="string">"userId"</span>);</span><br><span class="line">        String md5Path = exchange.getAttribute(<span class="string">"md5Path"</span>);</span><br><span class="line">        redisTemplate.opsForZSet().incrementScore(redisPath, md5Path, -<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">changeStatusCode</span><span class="params">(ServerWebExchange exchange, HttpStatus httpStatus)</span> </span>{</span><br><span class="line">        exchange.getResponse().setStatusCode(httpStatus);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="filter过滤请求"><a class="header-anchor" href="#filter过滤请求">¶</a>filter过滤请求</h3>
<h4 id="用户权限的过滤器"><a class="header-anchor" href="#用户权限的过滤器">¶</a>用户权限的过滤器</h4>
<p>Order：Integer.MIN_VALUE</p>
<p>一头一尾简单说完，那中间经历了哪些filter的处理过程呢，根据bean的Order加载顺序，下一个我们进行的是用户的验证AuthFilter，Order：Integer.MIN_VALUE：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthFilter</span> <span class="keyword">implements</span> <span class="title">MyFilter</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AuthFilter</span><span class="params">(RedisTemplate&lt;String, String&gt; redisTemplate)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">noPassFilter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>{</span><br><span class="line"></span><br><span class="line">        String path = exchange.getRequest().getPath().toString();</span><br><span class="line">        String md5Path = StringUtil.toMD5(path);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//接口是否启用</span></span><br><span class="line">        Boolean exist = redisTemplate.opsForSet().isMember(RedisPath.ALL_URL, md5Path);</span><br><span class="line">        <span class="keyword">if</span> (exist == <span class="keyword">null</span> || !exist) {</span><br><span class="line">            Result nullApi = <span class="keyword">new</span> Result(FailureResult.valueOf(<span class="string">"NULL_API"</span>));</span><br><span class="line">            <span class="keyword">return</span> ResponseUtil.newResponse(exchange, nullApi);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用户是否有权限</span></span><br><span class="line">        List&lt;String&gt; accessTokenList = exchange.getRequest().getQueryParams().get(<span class="string">"accessToken"</span>);</span><br><span class="line">        <span class="keyword">if</span> (accessTokenList == <span class="keyword">null</span> || accessTokenList.size() &lt; <span class="number">1</span>) {</span><br><span class="line">            Result missToken = <span class="keyword">new</span> Result(FailureResult.valueOf(<span class="string">"MISS_TOKEN"</span>));</span><br><span class="line">            <span class="keyword">return</span> ResponseUtil.newResponse(exchange, missToken);</span><br><span class="line">        }</span><br><span class="line">        String token = accessTokenList.get(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        String userId = redisTemplate.opsForValue().get(RedisPath.PERMISSION + token);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(userId)) {</span><br><span class="line">            Result expiredToken = <span class="keyword">new</span> Result(FailureResult.valueOf(<span class="string">"EXPIRED_TOKEN"</span>));</span><br><span class="line">            <span class="keyword">return</span> ResponseUtil.newResponse(exchange, expiredToken);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            Map&lt;Object, Object&gt; permission = redisTemplate.opsForHash().entries(RedisPath.USER_INFO + userId);</span><br><span class="line">            Object obj = permission.get(md5Path);</span><br><span class="line">            <span class="keyword">if</span> (obj == <span class="keyword">null</span>) {</span><br><span class="line">                Result impermissibleApi = <span class="keyword">new</span> Result(FailureResult.valueOf(<span class="string">"IMPERMISSIBLE_API"</span>));</span><br><span class="line">                <span class="keyword">return</span> ResponseUtil.newResponse(exchange, impermissibleApi);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                UserLimitEntity userLimitEntity = <span class="keyword">new</span> UserLimitEntity(obj.toString());</span><br><span class="line">                exchange.getAttributes().put(<span class="string">"userLimitEntity"</span>, userLimitEntity);</span><br><span class="line">                exchange.getAttributes().put(<span class="string">"userId"</span>, userId);</span><br><span class="line">                exchange.getAttributes().put(<span class="string">"md5Path"</span>, md5Path);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> Integer.MIN_VALUE;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>接口是否启用，通过Key值RedisPath.ALL_URL从Redis里面获取所有已经存在的API，然后对1、token是否带入参数；2、token是否为空进行判断，如果都通过，通过userId在Redis里面查找用户限制鉴权对象UserLimitEntity，UserLimitEntity和RedisPath.ALL_URL的获取都存在从MySQL缓存至Redis的过程，在下面的类InitHandler进行加载。</p>
<p>Order：1</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitHandler</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(InitHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> TokenBucketClient tokenBucketClient;</span><br><span class="line">    <span class="keyword">private</span> UrlMapper urlMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InitHandler</span><span class="params">(RedisTemplate&lt;String, String&gt; redisTemplate, TokenBucketClient tokenBucketClient, UrlMapper urlMapper)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">        <span class="keyword">this</span>.tokenBucketClient = tokenBucketClient;</span><br><span class="line">        <span class="keyword">this</span>.urlMapper = urlMapper;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        initEnum();</span><br><span class="line">        List&lt;Url&gt; urls = urlMapper.getAll();</span><br><span class="line">        initUrl(urls);</span><br><span class="line">        initUrlLimit(urls);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initEnum</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        LOG.info(<span class="string">"############ 枚举加载 开始 ############"</span>);</span><br><span class="line">        Resource resource = <span class="keyword">new</span> ClassPathResource(<span class="string">"FailureResult.properties"</span>);</span><br><span class="line">        InputStream is = resource.getInputStream();</span><br><span class="line">        BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is));</span><br><span class="line">        String tmp;</span><br><span class="line">        Map&lt;String, Object[]&gt; enumValues = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">20</span>);</span><br><span class="line">        <span class="keyword">while</span> ((tmp = reader.readLine()) != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">if</span> (!StringUtils.isEmpty(tmp) &amp;&amp; tmp.trim().indexOf(<span class="string">"#"</span>) != <span class="number">0</span>) {</span><br><span class="line">                String[] nameAndCodeMsg = tmp.split(<span class="string">"="</span>);</span><br><span class="line">                String name = nameAndCodeMsg[<span class="number">0</span>].trim();</span><br><span class="line">                String cav = nameAndCodeMsg[<span class="number">1</span>].trim();</span><br><span class="line">                String code = cav.substring(<span class="number">0</span>, cav.indexOf(<span class="string">","</span>));</span><br><span class="line">                String msg = cav.substring(cav.indexOf(<span class="string">","</span>) + <span class="number">1</span>);</span><br><span class="line">                Object[] value = <span class="keyword">new</span> Object[<span class="number">2</span>];</span><br><span class="line">                value[<span class="number">0</span>] = Integer.parseInt(code.trim());</span><br><span class="line">                value[<span class="number">1</span>] = msg.trim();</span><br><span class="line">                enumValues.put(name, value);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        EnumUtil.addEnum(FailureResult.class, new Class[]{int.class, String.class}, enumValues);</span><br><span class="line">        LOG.info(<span class="string">"############ 枚举加载 结束 ############"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化所有的可用url</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initUrl</span><span class="params">(List&lt;Url&gt; urls)</span> </span>{</span><br><span class="line">        LOG.info(<span class="string">"############ 缓存可用的URL到redis(共计:{}) 开始 ############"</span>, urls.size());</span><br><span class="line">        String[] urlArr = <span class="keyword">new</span> String[urls.size()];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; urls.size(); i++) {</span><br><span class="line">            urlArr[i] = urls.get(i).getId();</span><br><span class="line">        }</span><br><span class="line">        Long result = redisTemplate.opsForSet().add(RedisPath.ALL_URL, urlArr);</span><br><span class="line">        LOG.info(<span class="string">"############ 缓存可用的URL到redis(初始化:{}) 结束 ############"</span>, result == <span class="keyword">null</span> ? <span class="number">0</span> : result);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取所有限制接口访问频率的接口，初始化redis中对应的令牌桶信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initUrlLimit</span><span class="params">(List&lt;Url&gt; urls)</span> </span>{</span><br><span class="line">        LOG.info(<span class="string">"############ 初始化令牌桶(共计:{}) 开始 ############"</span>, urls.size());</span><br><span class="line">        <span class="keyword">int</span> total = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Url url : urls) {</span><br><span class="line">            <span class="keyword">if</span> (url.getBucketMaxSize() == <span class="number">0</span> || url.getQps() == <span class="number">0</span>) {</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            }</span><br><span class="line">            tokenBucketClient.init(RedisPath.URL_LIMIT + url.getId(), url.getBucketMaxSize(), url.getQps());</span><br><span class="line">            total++;</span><br><span class="line">        }</span><br><span class="line">        LOG.info(<span class="string">"############ 初始化令牌桶(初始化:{}) 结束 ############"</span>, total);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>可以看出类InitHandler中方法initUrl()初始化了所有的存在的urls（即已经存在于数据库中的API）,缓存至Redis,我们看看Mysql视图:</p>
<p><img src="/2020/03/26/spring-cloud-gateway/mysql-url.png" alt></p>
<p>Redis视图(只缓存url的Id)：</p>
<p><img src="/2020/03/26/spring-cloud-gateway/redis-url.png" alt></p>
<p>initEnum()方法初始化返回值错误类型的枚举类加载，initUrlLimit()初始化url的令牌桶，至于令牌什么时候用，我们后面说。</p>
<h4 id="用户访问速度的过滤器"><a class="header-anchor" href="#用户访问速度的过滤器">¶</a>用户访问速度的过滤器</h4>
<p>Order：Integer.MIN_VALUE+1</p>
<p>下面进入用户访问速度的过滤器，这里用到了redis+Lua的控制逻辑，直接上代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRateFilter</span> <span class="keyword">implements</span> <span class="title">MyFilter</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> UserRateClient userRateClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserRateFilter</span><span class="params">(UserRateClient userRateClient)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.userRateClient = userRateClient;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">noPassFilter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>{</span><br><span class="line"></span><br><span class="line">        UserLimitEntity userLimitEntity = exchange.getAttribute(<span class="string">"userLimitEntity"</span>);</span><br><span class="line">        <span class="keyword">if</span> (userLimitEntity.notRateLimit()) {</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        String userId = exchange.getAttribute(<span class="string">"userId"</span>);</span><br><span class="line">        String md5Path = exchange.getAttribute(<span class="string">"md5Path"</span>);</span><br><span class="line">        String redisPath = RedisPath.USER_RATE_LIMIT + userId + <span class="string">":"</span> + md5Path;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> acquire(redisPath,userLimitEntity.getRate(),exchange,chain);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> Integer.MIN_VALUE + <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Mono&lt;Void&gt; <span class="title">acquire</span><span class="params">(String redisPath, Map&lt;Integer,Integer&gt; limitInfo,ServerWebExchange exchange, GatewayFilterChain chain)</span></span>{</span><br><span class="line">        LuaScriptResult acquire = userRateClient.acquire(redisPath);</span><br><span class="line">        <span class="keyword">if</span> (acquire == LuaScriptResult.NEED_INIT) {</span><br><span class="line">            userRateClient.init(redisPath, limitInfo);</span><br><span class="line">            acquire = userRateClient.acquire(redisPath);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (acquire == LuaScriptResult.SUCCESS) {</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (acquire == LuaScriptResult.LIMITED) {</span><br><span class="line">            Result frequentRequest = <span class="keyword">new</span> Result(FailureResult.valueOf(<span class="string">"FREQUENT_REQUEST"</span>));</span><br><span class="line">            <span class="keyword">return</span> ResponseUtil.newResponse(exchange, frequentRequest);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"user limit acquire error"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>类UserRateFilte，如果不在类AuthFilter过滤器中的白名单，进入自定义的MyFilter noPassFilter()进入过滤器逻辑，其中UserLimitEntity，在上面提到的类InitHandler中，已经由用户管理系统(不用于此网关系统)Mysql缓存到Redis中，如图：</p>
<p><img src="/2020/03/26/spring-cloud-gateway/user-limit.png" alt></p>
<p>其中字段USED（已访问次数），TOTAL（总访问次数），RATE（访问速率），如：{60:10,3600:300}表示两个限制条件，此用户60秒最多可累计可访问10次，3600秒最多累计可访问300次，这个二元组个数可以根据需求随意添加。其中方法acquire()，将对用户限制的次数进行判断，并返回是否通过过滤，这里会由userRateClient加载user_rate_limit.lua对用户是否能够获取访问权限进行判断。先看看类userRateClient：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRateClient</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * redis客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * redis脚本调用类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"userRateLua"</span>)</span><br><span class="line">    <span class="keyword">private</span> RedisScript&lt;Long&gt; userRateScript;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserRateClient</span><span class="params">(StringRedisTemplate redisTemplate)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LuaScriptResult <span class="title">init</span><span class="params">(String path, Map&lt;Integer, Integer&gt; limit)</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Integer max = <span class="number">0</span>;</span><br><span class="line">            StringBuilder intervalSb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            intervalSb.append(<span class="string">"{"</span>);</span><br><span class="line">            StringBuilder countSb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            countSb.append(<span class="string">"{"</span>);</span><br><span class="line">            <span class="keyword">for</span> (Integer key : limit.keySet()) {</span><br><span class="line">                max = max &gt; key ? max : key;</span><br><span class="line">                intervalSb.append(key * <span class="number">1000</span>).append(<span class="string">","</span>);</span><br><span class="line">                countSb.append(limit.get(key)).append(<span class="string">","</span>);</span><br><span class="line">            }</span><br><span class="line">            intervalSb.deleteCharAt(intervalSb.length() - <span class="number">1</span>).append(<span class="string">"}"</span>);</span><br><span class="line">            countSb.deleteCharAt(countSb.length() - <span class="number">1</span>).append(<span class="string">"}"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> exec(path, UserRateLimitMethod.init, intervalSb.toString(), countSb.toString(), String.valueOf(max), String.valueOf(limit.size()));</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> LuaScriptResult.ERROR;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LuaScriptResult <span class="title">acquire</span><span class="params">(String path)</span> </span>{</span><br><span class="line">        LuaScriptResult exec = exec(path, UserRateLimitMethod.acquire);</span><br><span class="line">        <span class="keyword">return</span> exec;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> LuaScriptResult <span class="title">exec</span><span class="params">(String path, UserRateLimitMethod method, Object... params)</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            List&lt;String&gt; keys = <span class="keyword">new</span> ArrayList&lt;String&gt;() {{</span><br><span class="line">                add(path);</span><br><span class="line">                add(method.name());</span><br><span class="line">            }};</span><br><span class="line">            Long result = redisTemplate.execute(userRateScript, keys, params);</span><br><span class="line">            <span class="keyword">return</span> LuaScriptResult.getResult(result);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> LuaScriptResult.ERROR;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>UserRateClient里面的exec(path, UserRateLimitMethod.init, intervalSb.toString(), countSb.toString(), String.valueOf(max), String.valueOf(limit.size())) 方法，intervalSb和countSb都封装成{毫秒数:可访问数}这种多个二元组的形式，@Qualifier(“userRateLua”)通过Spring Configuration加载lua脚本user_rate_limit.lua:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">redis.replicate_commands()</span><br><span class="line"></span><br><span class="line">local method = KEYS[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">local curr_time_arr = redis.call(<span class="string">'TIME'</span>)</span><br><span class="line">local curr_time = curr_time_arr[<span class="number">1</span>] * <span class="number">1000</span> + math.floor(curr_time_arr[<span class="number">2</span>]/<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">local Result = {SUCCESS=<span class="number">1</span>,DEFEAT=<span class="number">0</span>,LIMITED=-<span class="number">1</span>,NEEDINIT=<span class="number">99</span>}</span><br><span class="line"></span><br><span class="line">local limit_info = redis.pcall(<span class="string">'HMGET'</span>,KEYS[<span class="number">1</span>],<span class="string">'interval'</span>,<span class="string">'max_count'</span>,<span class="string">'first_time'</span>,<span class="string">'count'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function">local function <span class="title">arr2str</span><span class="params">(arr)</span></span></span><br><span class="line"><span class="function">    local str </span>=  <span class="string">'{'</span></span><br><span class="line">    for i=1,#arr,1 do</span><br><span class="line">        str = str .. arr[i]</span><br><span class="line">        if i&lt;#arr then</span><br><span class="line">            str = str .. <span class="string">','</span></span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line">    <span class="keyword">return</span> str .. <span class="string">'}'</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> method == <span class="string">'init'</span> then</span><br><span class="line">    <span class="keyword">if</span>(type(limit_info[<span class="number">1</span>]) ~=<span class="string">'boolean'</span> and limit_info[<span class="number">1</span>] ~=nil) then</span><br><span class="line">        <span class="keyword">return</span> Result.DEFEAT</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    local curr_time_str = <span class="string">'{'</span></span><br><span class="line">    local count_str = <span class="string">'{'</span></span><br><span class="line">    <span class="keyword">for</span> i=<span class="number">1</span>,ARGV[<span class="number">4</span>],<span class="number">1</span> <span class="keyword">do</span></span><br><span class="line">        curr_time_str = curr_time_str .. curr_time</span><br><span class="line">        count_str = count_str .. <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> i &lt; tonumber(ARGV[<span class="number">4</span>]) then</span><br><span class="line">            curr_time_str = curr_time_str .. <span class="string">','</span></span><br><span class="line">            count_str = count_str .. <span class="string">','</span></span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line">    curr_time_str = curr_time_str .. <span class="string">'}'</span></span><br><span class="line">    count_str = count_str .. <span class="string">'}'</span></span><br><span class="line"></span><br><span class="line">    redis.pcall(<span class="string">'HMSET'</span>, KEYS[<span class="number">1</span>],</span><br><span class="line">        <span class="string">'interval'</span>, ARGV[<span class="number">1</span>],</span><br><span class="line">        <span class="string">'max_count'</span>, ARGV[<span class="number">2</span>],</span><br><span class="line">        <span class="string">'first_time'</span>, curr_time_str,</span><br><span class="line">        <span class="string">'count'</span>, count_str)</span><br><span class="line">    redis.pcall(<span class="string">'EXPIRE'</span>,KEYS[<span class="number">1</span>],ARGV[<span class="number">3</span>])</span><br><span class="line">    <span class="keyword">return</span> Result.SUCCESS</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> method == <span class="string">'acquire'</span> then</span><br><span class="line">    <span class="keyword">if</span>(type(limit_info[<span class="number">1</span>]) ==<span class="string">'boolean'</span> or limit_info[<span class="number">1</span>] ==nil) then</span><br><span class="line">        <span class="keyword">return</span> Result.NEEDINIT</span><br><span class="line">    end</span><br><span class="line">    local interval = loadstring(<span class="string">'return '</span> .. limit_info[<span class="number">1</span>])()</span><br><span class="line">    local max_count = loadstring(<span class="string">'return '</span> .. limit_info[<span class="number">2</span>])()</span><br><span class="line">    local first_time = loadstring(<span class="string">'return '</span> .. limit_info[<span class="number">3</span>])()</span><br><span class="line">    local count = loadstring(<span class="string">'return '</span> .. limit_info[<span class="number">4</span>])()</span><br><span class="line"></span><br><span class="line">    for i=1,#interval,1 do</span><br><span class="line">        <span class="keyword">if</span> curr_time-first_time[i] &gt; interval[i] then</span><br><span class="line">            first_time[i] = curr_time</span><br><span class="line">            count[i] = <span class="number">0</span></span><br><span class="line">        end</span><br><span class="line">        <span class="keyword">if</span> count[i] &gt;= max_count[i] then</span><br><span class="line">            <span class="keyword">return</span> Result.LIMITED</span><br><span class="line">        end</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    for i=1,#interval,1 do</span><br><span class="line">        count[i] = count[i] + <span class="number">1</span></span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">    redis.pcall(<span class="string">'HSET'</span>, KEYS[<span class="number">1</span>], <span class="string">'first_time'</span>, arr2str(first_time),<span class="string">'count'</span>,arr2str(count))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.SUCCESS</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>
<p>如果不懂lua脚本语法，可以去网上先了解一下，作为redis分布式锁原子性实现的利器（redis官方推出的解决方案），在进行redis分布式锁设计的时候也可以大展拳脚，实际顺手程度非常推荐。说远了，回来到上面的lua脚本。init方法初始化用户限流的各项参数，interval-时间间隔，max_count-最大访问次数，first_time-第一次访问时间，count-置0，当然是实际是{0}样子，上面做了字符串的拼接，这是lua的数组包装形式，在acquire方法里面如果redis里面没有进行初始化的话就进行初始化，在Redis里面的视图是：</p>
<p><img src="/2020/03/26/spring-cloud-gateway/user-rate-limit.png" alt></p>
<p>acquire发现，如果当前时间减去第一次时间大于时间间隔，用户已使用次数count归0，并把curr_time（当前时间）赋值给first_time（第一次时间）,如果在这个时间间隔内，使用次数count+1，如果访问次数大于最大访问次数，返回Result.LIMITED，如果返回Result.SUCCESS，通过类UserRateFilter的过滤条件，进入下一个过滤器。</p>
<h4 id="接口访问速度的过滤器"><a class="header-anchor" href="#接口访问速度的过滤器">¶</a>接口访问速度的过滤器</h4>
<p>Order：Integer.MIN_VALUE+2</p>
<p>类UrlRateFilter是对接口访问速度的控制，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UrlRateFilter</span> <span class="keyword">implements</span> <span class="title">MyFilter</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TokenBucketClient tokenBucketClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UrlRateFilter</span><span class="params">(TokenBucketClient tokenBucketClient)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.tokenBucketClient = tokenBucketClient;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">noPassFilter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>{</span><br><span class="line"></span><br><span class="line">        String md5Path = exchange.getAttribute(<span class="string">"md5Path"</span>);</span><br><span class="line">        LuaScriptResult acquire = tokenBucketClient.acquire(RedisPath.URL_LIMIT + md5Path);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (acquire == LuaScriptResult.SUCCESS) {</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (acquire == LuaScriptResult.LIMITED) {</span><br><span class="line">            Result limitedApi = <span class="keyword">new</span> Result(FailureResult.valueOf(<span class="string">"LIMITED_API"</span>));</span><br><span class="line">            <span class="keyword">return</span> ResponseUtil.newResponse(exchange, limitedApi);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"api limit acquire error"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> Integer.MIN_VALUE + <span class="number">2</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>调用TokenBucketClient进行控制逻辑，此处的逻辑和上面的用户访问控制有点区别，这里面的初始化，即令牌的初始化在类initHandler里面的initUrlLimit()方法已经初始化了，缓存至Redis如图：</p>
<p><img src="/2020/03/26/spring-cloud-gateway/url-limit.png" alt></p>
<p>里面参数表示：bucket_max_size（令牌桶里面最大令牌数），interval（产生令牌的时间间隔），token（token数），更新时间（timestamp）。关于令牌桶的概念，不清楚的话，可先查看<a href="https://segmentfault.com/a/1190000015967922" target="_blank" rel="noopener">令牌桶概念</a>、<a href="https://www.jianshu.com/p/864ddda9288f" target="_blank" rel="noopener">实现例子</a>。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenBucketClient</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * redis客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * redis脚本调用类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"tokenBucketLua"</span>)</span><br><span class="line">    <span class="keyword">private</span> RedisScript&lt;Long&gt; rateLimitScript;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TokenBucketClient</span><span class="params">(StringRedisTemplate redisTemplate)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LuaScriptResult <span class="title">init</span><span class="params">(String path, <span class="keyword">int</span> bucketMaxSize, <span class="keyword">int</span> qps)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> init(path,bucketMaxSize,getInterval(qps));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LuaScriptResult <span class="title">init</span><span class="params">(String path, <span class="keyword">int</span> bucketMaxSize, <span class="keyword">float</span> interval)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> exec(path, TbRateLimitMethod.init, bucketMaxSize, interval, bucketMaxSize);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LuaScriptResult <span class="title">modify</span><span class="params">(String path, <span class="keyword">int</span> bucketMaxSize, <span class="keyword">int</span> qps)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> modify(path, bucketMaxSize, getInterval(qps));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LuaScriptResult <span class="title">modify</span><span class="params">(String path, <span class="keyword">int</span> bucketMaxSize, <span class="keyword">float</span> interval)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> exec(path, TbRateLimitMethod.modify, bucketMaxSize, interval);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LuaScriptResult <span class="title">delete</span><span class="params">(String path)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> exec(path, TbRateLimitMethod.delete);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LuaScriptResult <span class="title">acquire</span><span class="params">(String path)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> acquire(path, <span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LuaScriptResult <span class="title">acquire</span><span class="params">(String path, <span class="keyword">int</span> acquireToken)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> exec(path, TbRateLimitMethod.acquire, acquireToken);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> LuaScriptResult <span class="title">exec</span><span class="params">(String path, TbRateLimitMethod method, Object... params)</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            String[] allParams = <span class="keyword">new</span> String[params.length + <span class="number">1</span>];</span><br><span class="line">            allParams[<span class="number">0</span>] = method.name();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; params.length; index++) {</span><br><span class="line">                allParams[<span class="number">1</span> + index] = params[index].toString();</span><br><span class="line">            }</span><br><span class="line">            Long result = redisTemplate.execute(rateLimitScript,</span><br><span class="line">                    Collections.singletonList(path),</span><br><span class="line">                    allParams);</span><br><span class="line">            <span class="keyword">return</span> LuaScriptResult.getResult(result);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> LuaScriptResult.ERROR;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">getInterval</span><span class="params">(<span class="keyword">int</span> qps)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1000.0f</span> / qps;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>
<p>控制令牌产生的lua脚本如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">redis.replicate_commands()</span><br><span class="line"></span><br><span class="line">local Result = {SUCCESS=<span class="number">1</span>,DEFEAT=<span class="number">0</span>,LIMITED=-<span class="number">1</span>}</span><br><span class="line"></span><br><span class="line">local token_bucket_info = redis.pcall(<span class="string">'HMGET'</span>,KEYS[<span class="number">1</span>],<span class="string">'bucket_max_size'</span>,<span class="string">'interval'</span>,<span class="string">'token'</span>,<span class="string">'timestamp'</span>)</span><br><span class="line"></span><br><span class="line">local bucket_max_size = tonumber(token_bucket_info[<span class="number">1</span>])</span><br><span class="line">local interval = tonumber(token_bucket_info[<span class="number">2</span>])</span><br><span class="line">local token = tonumber(token_bucket_info[<span class="number">3</span>])</span><br><span class="line">local timestamp = token_bucket_info[<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line">local method = ARGV[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">local curr_time_arr = redis.call(<span class="string">'TIME'</span>)</span><br><span class="line">local curr_timestamp = curr_time_arr[<span class="number">1</span>] * <span class="number">1000</span> + math.floor(curr_time_arr[<span class="number">2</span>]/<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> method == <span class="string">'init'</span> then</span><br><span class="line">    <span class="keyword">if</span>(type(timestamp) ~=<span class="string">'boolean'</span> and timestamp ~=nil) then</span><br><span class="line">        <span class="keyword">return</span> Result.SUCCESS</span><br><span class="line">    end</span><br><span class="line">    redis.pcall(<span class="string">'HMSET'</span>, KEYS[<span class="number">1</span>],</span><br><span class="line">        <span class="string">'bucket_max_size'</span>, ARGV[<span class="number">2</span>],</span><br><span class="line">        <span class="string">'interval'</span>, ARGV[<span class="number">3</span>],</span><br><span class="line">        <span class="string">'token'</span>, ARGV[<span class="number">4</span>],</span><br><span class="line">        <span class="string">'timestamp'</span>, curr_timestamp)</span><br><span class="line">    <span class="keyword">return</span> Result.SUCCESS</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> method == <span class="string">'modify'</span> then</span><br><span class="line">    <span class="keyword">if</span>(type(timestamp)==<span class="string">'boolean'</span> and timestamp==nil) then</span><br><span class="line">        <span class="keyword">return</span> Result.DEFEAT</span><br><span class="line">    end</span><br><span class="line">    redis.pcall(<span class="string">'HMSET'</span>, KEYS[<span class="number">1</span>],</span><br><span class="line">        <span class="string">'bucket_max_size'</span>, ARGV[<span class="number">2</span>],</span><br><span class="line">        <span class="string">'interval'</span>, ARGV[<span class="number">3</span>])</span><br><span class="line">    <span class="keyword">return</span> Result.SUCCESS</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> method == <span class="string">'delete'</span> then</span><br><span class="line">    <span class="keyword">if</span>(type(timestamp) ==<span class="string">'boolean'</span> or timestamp ==nil) then</span><br><span class="line">        <span class="keyword">return</span> Result.SUCCESS</span><br><span class="line">    end</span><br><span class="line">    redis.pcall(<span class="string">'DEL'</span>, KEYS[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> Result.SUCCESS</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> method == <span class="string">'acquire'</span> then</span><br><span class="line">    <span class="keyword">if</span>(type(timestamp) ==<span class="string">'boolean'</span> or timestamp ==nil) then</span><br><span class="line">        <span class="keyword">return</span> Result.SUCCESS</span><br><span class="line">    end</span><br><span class="line">    --获取认证消耗的令牌数</span><br><span class="line">    local acquire_token = tonumber(ARGV[<span class="number">2</span>])</span><br><span class="line">    --计算当前时间与上一次认证的时间差内改产生的令牌数</span><br><span class="line">    local reserve_token = math.max(<span class="number">0</span>, math.floor((curr_timestamp - timestamp) / interval))</span><br><span class="line">    --如果超出桶的最大令牌数，则抛弃</span><br><span class="line">    local curr_token = math.min(bucket_max_size, token + reserve_token)</span><br><span class="line">    local result = Result.LIMITED</span><br><span class="line">    --如果桶中令牌数量够则放行</span><br><span class="line">    <span class="keyword">if</span> curr_token &gt;= acquire_token then</span><br><span class="line">        result = Result.SUCCESS</span><br><span class="line">        curr_token = curr_token - acquire_token</span><br><span class="line">    end</span><br><span class="line">    --更新当前桶中的令牌数量</span><br><span class="line">    redis.pcall(<span class="string">'HSET'</span>, KEYS[<span class="number">1</span>], <span class="string">'token'</span>, curr_token)</span><br><span class="line">    --如果这次有放入令牌，则更新时间</span><br><span class="line">    <span class="keyword">if</span> reserve_token &gt; <span class="number">0</span> then</span><br><span class="line">        redis.pcall(<span class="string">'HSET'</span>, KEYS[<span class="number">1</span>], <span class="string">'timestamp'</span>, curr_timestamp)</span><br><span class="line">    end</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">end</span><br></pre></td></tr></tbody></table></figure>
<p>acquire方法里面 acquire_token传值是1（即每次访问消耗令牌数1），更新时间差与interval比值产生对应令牌数，如果桶里面令牌大于acquire_token，则放行，返回Result.SUCCESS，完成接口访问速率的控制。</p>
<h4 id="用户总访问次数控制过滤器"><a class="header-anchor" href="#用户总访问次数控制过滤器">¶</a>用户总访问次数控制过滤器</h4>
<p>Order：Integer.MIN_VALUE+3</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserCountFilter</span> <span class="keyword">implements</span> <span class="title">MyFilter</span> </span>{</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserCountFilter</span><span class="params">(RedisTemplate&lt;String, String&gt; redisTemplate)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">noPassFilter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>{</span><br><span class="line"></span><br><span class="line">        ZSetOperations&lt;String, String&gt; zSet = redisTemplate.opsForZSet();</span><br><span class="line"></span><br><span class="line">        UserLimitEntity userLimitEntity = exchange.getAttribute(<span class="string">"userLimitEntity"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (userLimitEntity.notCountLimit()) {</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        String redisPath = RedisPath.USER_COUNT_LIMIT + exchange.getAttribute(<span class="string">"userId"</span>);</span><br><span class="line">        String md5Path = exchange.getAttribute(<span class="string">"md5Path"</span>);</span><br><span class="line"></span><br><span class="line">        Double count = zSet.incrementScore(redisPath, md5Path, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">1</span> &amp;&amp; userLimitEntity.getUsed() != <span class="number">0</span>) {</span><br><span class="line">            zSet.incrementScore(redisPath, md5Path, userLimitEntity.getUsed());</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (count &gt; userLimitEntity.getTotal()) {</span><br><span class="line">            zSet.incrementScore(redisPath, md5Path, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            Result limitedCount = <span class="keyword">new</span> Result(FailureResult.valueOf(<span class="string">"LIMITED_COUNT"</span>));</span><br><span class="line">            <span class="keyword">return</span> ResponseUtil.newResponse(exchange, limitedCount);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> Integer.MIN_VALUE + <span class="number">3</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>UserLimitEntity用户控制里面有个total，表示用户可以访问最大次数，上面过滤器进行访问值的判断，如果大于，返回FailureResult.valueOf(“LIMITED_COUNT”)，错误结果通过枚举形式把配置文件的自定义的错误码（下图），在前文提到的InitHandler类中进行加载。</p>
<p>FailureResult.properties:</p>
<p><img src="/2020/03/26/spring-cloud-gateway/failed-result.png" alt></p>
<h3 id="通过网关加载访问业务层"><a class="header-anchor" href="#通过网关加载访问业务层">¶</a>通过网关加载访问业务层</h3>
<p>经过上面过滤器，我们完成了对用户的鉴权和限流的设计和控制，之后正式进行业务层逻辑访问，本文完。</p>
<p>Gitlab：<a href="http://git.octodata.com.cn/jiangyunjun/open-api-gateway" target="_blank" rel="noopener">项目地址</a></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/avatar.png"
                alt="Karel" />
            
              <p class="site-author-name" itemprop="name">Karel</p>
              <p class="site-description motion-element" itemprop="description">Make western countries' engineers ashamed</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives%7C%7C%20archive">
              
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Karel</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>




















  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: true,
        appId: 'k5BH3xlRBUr38ElbwzE7Qpzz-gzGzoHsz',
        appKey: 'lDxxfhr6Rt45b7osnELwF3SX',
        placeholder: '评论区（如果期待指定回复，可填写上面的昵称和你的邮箱）',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("k5BH3xlRBUr38ElbwzE7Qpzz-gzGzoHsz", "lDxxfhr6Rt45b7osnELwF3SX");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
